---
import * as Sentry from "@sentry/astro";
import { API_AUTH, API_URL } from "astro:env/server";

export const prerender = false;

const { memberId } = Astro.params;
if (!memberId) {
  Sentry.captureMessage("Access non-existing event.");
  return Astro.redirect("/404");
}

try {
  const response = await fetch(`${API_URL}/subscribers/${memberId}`, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${API_AUTH}` },
  });

  if (!response.ok) {
    throw new Error("Failed to unsubscribe member.");
  }

  return Astro.redirect("/newsletter/unsubscribe");
} catch (error) {
  Sentry.captureException(error);
  return Astro.redirect("/404");
}
---
