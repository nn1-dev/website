---
import * as Sentry from "@sentry/astro";
import { getEntry } from "astro:content";
import { getInviteUrls } from "../../../../../utils";
import { API_AUTH, API_URL } from "astro:env/server";

export const prerender = false;

const { eventId, ticketId, token } = Astro.params;
if (!eventId || !ticketId || !token) {
  Sentry.captureMessage("Access non-existing event.");
  return Astro.redirect("/404");
}

const entry = await getEntry("events", eventId);
if (entry === undefined) {
  Sentry.captureMessage("Access non-existing event.");
  return Astro.redirect("/404");
}

if (!API_URL || !API_AUTH) {
  Sentry.captureException("API_AUTH is not defined.");
  throw new Error("API_URL or API_AUTH is not defined.");
}

try {
  const response = await fetch(`${API_URL}/tickets/${eventId}/${ticketId}`, {
    headers: { Authorization: `Bearer ${API_AUTH}` },
  });

  if (!response.ok) {
    throw new Error("Ticket doesn't exist.");
  }

  const responseJson:
    | {
        status: "success";
        data: {
          id: string;
          event_id: number;
          email: string;
          name: string;
          confirmed: number;
          confirmation_token: string;
          subscribe: number;
          created_at: string;
        };
      }
    | { status: "error"; data: null } = await response.json();

  if (responseJson.data?.confirmed) {
    return Astro.redirect(`/events/${eventId}/${ticketId}`);
  }
} catch (error) {
  Sentry.captureException(error);
  return Astro.redirect("/404");
}

const {
  data: { id, name, description, dateStart, dateEnd, location },
} = entry;

const inviteUrls = getInviteUrls({
  id,
  name,
  description,
  location,
  dateStart,
  dateEnd,
});

const dateStartParsed = dateStart.toLocaleDateString("en-GB", {
  weekday: "long",
  year: "numeric",
  month: "2-digit",
  day: "2-digit",
  hour: "2-digit",
  minute: "2-digit",
});

try {
  const response = await fetch(`${API_URL}/tickets/${eventId}/${ticketId}`, {
    method: "PUT",
    headers: { Authorization: `Bearer ${API_AUTH}` },
    body: JSON.stringify({
      eventName: entry.data.name,
      eventDate: dateStartParsed,
      eventLocation: location,
      eventInviteUrlIcal: inviteUrls.iCal,
      eventInviteUrlGoogle: inviteUrls.google,
      confirmationToken: token,
    }),
  });

  if (!response.ok) {
    throw new Error("Token validation failed.");
  }

  return Astro.redirect(`/events/${eventId}/${ticketId}`);
} catch (error) {
  Sentry.captureException(error);
  return Astro.redirect("/404");
}
---
