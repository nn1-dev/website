---
import * as Sentry from "@sentry/astro";
import { getEntry } from "astro:content";
import Layout from "../../../../layouts/Layout.astro";
import { API_AUTH, API_URL } from "astro:env/server";
import TicketNotConfirmed from "../../../../sections/TicketNotConfirmed.astro";
import TicketSuccess from "../../../../sections/TicketSuccess.astro";

export const prerender = false;

const { eventId, ticketId } = Astro.params;
if (!eventId || !ticketId) {
  Sentry.captureMessage("Access non-existing event.");
  return Astro.redirect("/404");
}

const entry = await getEntry("events", eventId);
if (entry === undefined) {
  Sentry.captureMessage("Access non-existing event.");
  return Astro.redirect("/404");
}

let ticketConfirmed = false;
let ticketName = "";
let ticketEmail = "";
let ticketTimestamp = "";

try {
  const response = await fetch(`${API_URL}/tickets/${eventId}/${ticketId}`, {
    headers: { Authorization: `Bearer ${API_AUTH}` },
  });

  if (!response.ok) {
    throw new Error("Ticket doesn't exist.");
  }

  const responseJson:
    | {
        status: "success";
        data: {
          id: string;
          event_id: number;
          email: string;
          name: string;
          confirmed: number;
          confirmation_token: string;
          subscribe: number;
          created_at: string;
        };
        error: null;
      }
    | { status: "error"; data: string } = await response.json();

  if (responseJson.status === "error") {
    throw new Error("Ticket doesn't exist.");
  }

  ticketTimestamp = responseJson.data.created_at;

  if (responseJson.data.confirmed) {
    ticketConfirmed = true;
    ticketName = responseJson.data.name;
    ticketEmail = responseJson.data.email;

    // no cache in the browser
    Astro.response.headers.set(
      "Cache-Control",
      "public, max-age=0, must-revalidate",
    );
  }
} catch (error) {
  Sentry.captureException(error);
  return Astro.redirect("/404");
}

const {
  data: { id, name, description, location, dateStart, dateEnd },
} = entry;
---

<Layout title={`${name} | NN1 Dev Club`} description={description} noIndex>
  {
    ticketConfirmed ? (
      <TicketSuccess
        eventId={id}
        eventName={name}
        eventDescription={description}
        eventLocation={location}
        eventDateStart={dateStart}
        eventDateEnd={dateEnd}
        ticketId={ticketId}
        ticketName={ticketName}
        ticketEmail={ticketEmail}
      />
    ) : (
      <TicketNotConfirmed id={id} timestamp={ticketTimestamp} />
    )
  }
</Layout>
